import { useRouter } from "next/router";
import styled from "styled-components";
import Head from "next/head";
import Image, { StaticImageData } from "next/image";
import { isSafari } from "react-device-detect";
import { motion } from "framer-motion";
import { GetStaticProps, GetStaticPaths } from "next";
import { fetchProjectsOnce, fetchProjectBySlug } from "@/firebase/firebaseOperations";
import { Project } from "@/data/projects";
import Motion from "@/components/Motion";

const container = {
	hidden: { opacity: 1 },
	show: {
		opacity: 1,
		transition: {
			staggerChildren: 0.15,
		},
	},
};

const item = {
	hidden: { x: 0, y: "5vh", opacity: 0 },
	show: {
		x: 0,
		y: 0,
		opacity: 1,
		transition: {
			type: "tween",
			ease: "anticipate",
			duration: 1,
		},
	},
};

const CaseCSS = styled.div``;

interface ProjectPageProps {
	project: Project;
}

const ProjectPage: React.FC<ProjectPageProps> = ({ project }) => {
	const router = useRouter();

	if (router.isFallback) {
		return <div>Loading...</div>;
	}

	if (!project) {
		return <div>Project not found</div>;
	}

	return (
		<CaseCSS>
			<Head>
				<title>{project.title} | Sahand Porkar</title>
				<meta name="description" content="Generated by create next app" />
				<meta name="viewport" content="width=device-width, initial-scale=1" />
				<link rel="icon" href="/favicon.ico" />
			</Head>
			<Motion>
				<motion.div initial="hidden" animate="show" variants={container}>
					<main className="mt-5">
						<div className="px-6 container">
							<div className="sticky top-0 py-4 col-span-12 z-[90] bg-zinc-50">
								<div className="text-container">
									<h1 className="text-lg font-bold">{project.title}</h1>
									<h2 className="font-bold text-[.65rem] uppercase mt-1">
										<span className="mr-3 tracking-wider">{project.category} </span>
										{project.subcategories?.map((item: string, i: number, array: Array<string>) => (
											<span key={i} className={i !== array.length - 1 ? "mr-3 tracking-wider" : ""}>
												{item}
											</span>
										))}
									</h2>
								</div>
							</div>
							<div className="grid grid-cols-12">
								<motion.div variants={item} className="col-span-12 mb-5 md:mb-8">
									<div className="grid grid-cols-12">
										{project.description && (
											<div className="mb-5 sm:col-span-12 col-span-12">
												<p>{project.description}</p>
											</div>
										)}
									</div>
								</motion.div>
								<motion.div variants={item} className="col-span-12 bg-zinc-50">
									<div className="grid grid-cols-12 gap-[10px]">
										{project.media?.videos?.map((video, i) => (
											<div key={i} className="col-span-12 mb-10">
												<video preload="none" controls controlsList="nodownload" playsInline poster={video.poster?.src} src={isSafari ? video.mp4 : video.webm}></video>
												{video.desc && <p className="text-center mt-5 pl-2 col-span-12 font-medium">{video.desc}</p>}
											</div>
										))}
										{project.media?.images?.map((image, i) => (
											<div key={i} className="col-span-12 mb-3 md:mb-10">
												<Image draggable={false} className="w-100" src={image.data.src} width={image.data.width} height={image.data.height} alt={image?.desc} />
												{image?.desc && <p className="text-center mt-5 pl-2 col-span-12 font-medium">{image?.desc}</p>}
											</div>
										))}
									</div>
								</motion.div>
							</div>
						</div>
					</main>
				</motion.div>
			</Motion>
		</CaseCSS>
	);
};

export const getStaticPaths: GetStaticPaths = async () => {
	const projects = await fetchProjectsOnce();
	const paths = projects.map((project) => ({
		params: { case: project.slug },
	}));
	return { paths, fallback: true };
};

export const getStaticProps: GetStaticProps = async ({ params }) => {
	if (!params || typeof params.case !== "string") {
		return {
			notFound: true,
		};
	}

	const project = await fetchProjectBySlug(params.case);

	if (!project) {
		return {
			notFound: true,
		};
	}

	return {
		props: {
			project,
		},
		revalidate: 10,
	};
};

export default ProjectPage;
